# Stage 1 – MVP Essentials

**Technologies**
- Python 3.9+ core, `typer` for CLI, `GitPython` for repository operations, `pydantic`/`dataclasses` for structs, `PyYAML` for config, `rich` for terminal feedback.
- `openrouter` client or `requests` wrapper for Gemini 2.5 Flash access and prompt submission.
- `tree-sitter` (or `ast`/`lib2to3` as fallback) for language parsing of Python and JS/TS.
- Mermaid diagram generation via Mermaid CLI invocation (optional) and plain `.mmd` writers.
- OpenCode CLI (`opencode -p ... -f json`) for headless repo analysis and repeatable custom commands stored in `.opencode/commands`.

**Design Patterns**
- CLI command pattern using `typer` commands and subcommands, delegating repo introspection work to OpenCode sessions.
- Builder/facade pattern for orchestrating stages: repository loader → analyzer → documentation generator, with OpenCode custom command hooks between analyzer and doc generator.
- Strategy pattern for handling different analysis depth (`quick`, `standard`, `deep`) and mapping each depth to a specific OpenCode command (`project:quick-scan`, `project:standard-scan`, etc.).
- Singleton/config manager for global config access (via `pydantic` settings) that also stores OpenCode connection details (binary path, server URL when used).

**Components**
- `cli` module: entry point, argument parsing, config loading, logging, and launching OpenCode runs (`subprocess` or SDK) based on requested command.
- `repository_loader`: local path resolution, Git clone helper, authentication stub reused by OpenCode custom commands.
- `analyzer`: prepares prompts/configs for OpenCode, summarizes structure, defers to `tree-sitter`/AST per language when local enrichment is needed.
- `llm_service`: prompt templates, OpenRouter integration helper, response validation for locally generated sections.
- `doc_generator`: Markdown file writer, table of contents builder, index creation, and ingestion of files generated by OpenCode (architecture.md, diagrams, etc.).
- `diagram_generator`: Emit basic Mermaid component diagrams or import ones produced by OpenCode commands.
- `output_manager`: Ensures directories exist, writes metadata/logs, tracks config, and records OpenCode session IDs.

**Functionality**
- Run `repo-explainer analyze` against a Python or JS/TS repo and, via OpenCode CLI, request architecture.md, component diagrams, and tech stack files using predefined commands.
- Generate or import Mermaid architecture diagrams reflecting the repository’s primary components (OpenCode output is canonical, local generator is fallback).
- Persist metadata/log files showing the analyzed repo path, configuration used, and OpenCode session IDs/output manifests.

**Agent Architecture**
- **Pattern**: Single-agent sequential pipeline where the Typer CLI orchestrator invokes OpenCode headless commands between loader/analyzer/doc steps (loader → OpenCode run → doc writer), with optional local enrichment.
- **Orchestrator role**: `cli` command maintains deterministic flow, passing intermediate summaries and OpenCode output manifests downstream, akin to Azure’s sequential orchestration guidance.
- **Tooling**: CLI agent exposes intents (analyze/update) and triggers OpenCode via `subprocess` or SDK; `.opencode/commands/*.md` define reusable prompts. Claude Code remains an optional fallback for schema-enforced summaries when OpenCode is unavailable.
- **Validation**: Failures short-circuit later stages, surfacing OpenCode/Claude session IDs and stdout to the operator for quick retries.

**Deliverables**
- `repo-explainer analyze/update` commands producing markdown docs, logs, and at least one architecture diagram by invoking OpenCode custom commands.
- Baseline `.opencode/commands/analyze-architecture.md` (and `quick/standard/deep` variants) that wrap the OpenCode prompt shown in research, outputting `architecture.md`, `components.mermaid`, `dataflow.mermaid`, and `tech-stack.txt`, plus documented Claude Code equivalents.
- Documented Claude Code CLI fallback (`claude -p ... --allowedTools Read,Glob,Grep,Edit,Write --output-format json`) for the same deliverables when OpenCode is unavailable.
- Support for Python and JavaScript/TypeScript repositories only.
- Initial prompts tuned for structure detection, verifying outputs against static summaries.

## Diagrams
- Backend architecture: `diagrams/stage_1/backend.mmd`
- TUI interaction: `diagrams/stage_1/tui.mmd`
