# Stage 1 – MVP Essentials

**Technologies**
- Python 3.9+ core, `typer` for CLI, `GitPython` for repository operations, `pydantic`/`dataclasses` for structs, `PyYAML` for config, `rich` for terminal feedback.
- OpenCode CLI configured with OpenRouter’s Gemini 3 Flash Preview model (`opencode ... --model openrouter/google/gemini-3-flash-preview`).
- `tree-sitter` (or `ast`/`lib2to3` as fallback) for language parsing of Python and JS/TS.
- Mermaid diagram generation via Mermaid CLI invocation (optional) and plain `.mmd` writers.
- OpenCode CLI (`opencode -p ... -f json`) for headless repo analysis and repeatable custom commands stored in `.opencode/commands`.

**Design Patterns**
- CLI command pattern using `typer` commands and subcommands, delegating repo introspection work to OpenCode sessions.
- Builder/facade pattern for orchestrating stages: repository loader → analyzer → documentation generator, with OpenCode custom command hooks between analyzer and doc generator.
- Strategy pattern for handling different analysis depth (`quick`, `standard`, `deep`) and mapping each depth to a specific OpenCode command (`project:quick-scan`, `project:standard-scan`, etc.).
- Singleton/config manager for global config access (via `pydantic` settings) that also stores OpenCode connection details (binary path, server URL when used).

**Components**
- `cli` module: entry point, argument parsing, config loading, logging, and launching OpenCode runs (`subprocess` or SDK) based on requested command.
- `repository_loader`: local path resolution, Git clone helper, authentication stub reused by OpenCode custom commands.
- `analyzer`: prepares prompts/configs for OpenCode, summarizes structure, defers to `tree-sitter`/AST per language when local enrichment is needed.
- `llm_service`: prompt templates, OpenRouter integration helper, response validation for locally generated sections.
- `doc_generator`: Markdown file writer, table of contents builder, index creation, and ingestion of files generated by OpenCode (architecture.md, diagrams, etc.).
- `diagram_generator`: Emit basic Mermaid component diagrams or import ones produced by OpenCode commands.
- `output_manager`: Ensures directories exist, writes metadata/logs, tracks config, and records OpenCode session IDs.

**Functionality**
- Run `repo-explainer analyze` against a Python or JS/TS repo and, via OpenCode CLI, request architecture.md, component diagrams, and tech stack files using predefined commands.
- Generate or import Mermaid architecture diagrams reflecting the repository’s primary components (OpenCode output is canonical, local generator is fallback).
- Persist metadata/log files showing the analyzed repo path, configuration used, and OpenCode session IDs/output manifests.

**Agent Architecture**
- **Pattern**: Single-agent sequential pipeline where the Typer CLI orchestrator invokes OpenCode headless commands between loader/analyzer/doc steps (loader → OpenCode run → doc writer), with optional local enrichment.
- **Orchestrator role**: `cli` command maintains deterministic flow, passing intermediate summaries and OpenCode output manifests downstream, akin to Azure’s sequential orchestration guidance.
- **Tooling**: CLI agent exposes intents (analyze/update) and triggers OpenCode via `subprocess` or SDK; `.opencode/commands/*.md` define reusable prompts. Claude Code remains an optional fallback for schema-enforced summaries when OpenCode is unavailable.
- **Validation**: Failures short-circuit later stages, surfacing OpenCode/Claude session IDs and stdout to the operator for quick retries.

**Deliverables**
- `repo-explainer analyze/update` commands producing markdown docs, logs, and at least one architecture diagram by invoking OpenCode custom commands.
- Baseline `.opencode/commands/analyze-architecture.md` (and `quick/standard/deep` variants) that wrap the OpenCode prompt shown in research, outputting `architecture.md`, `components.mermaid`, `dataflow.mermaid`, and `tech-stack.txt`, plus documented Claude Code equivalents.
- Documented Claude Code CLI fallback (`claude -p ... --allowedTools Read,Glob,Grep,Edit,Write --output-format json`) for the same deliverables when OpenCode is unavailable.
- Support for Python and JavaScript/TypeScript repositories only.
- Initial prompts tuned for structure detection, verifying outputs against static summaries using Gemini 3 Flash Preview defaults.

## Diagrams
- Backend architecture: `diagrams/stage_1/backend.mmd`
- TUI interaction: `diagrams/stage_1/tui.mmd`

## Implementation Checklist

### Core Infrastructure
- [x] Project structure (`src/repo_explainer/`)
- [x] `pyproject.toml` with dependencies (typer, rich, pydantic, GitPython)
- [x] Configuration management (`config.py` with pydantic-settings)
- [x] Entry point script (`repo-explain` command)

### CLI Module
- [x] Typer-based CLI entry point (`cli.py`)
- [x] `analyze` command with depth options (quick/standard/deep)
- [x] `analyze` command accepts both local paths and Git URLs
- [x] `--force-clone` flag for re-cloning Git repositories
- [x] `update` command placeholder
- [x] Rich terminal feedback (panels, progress spinners)
- [ ] Logging configuration
- [ ] Config file loading (YAML)

### OpenCode Integration
- [x] OpenCode service wrapper (`opencode_service.py`)
- [x] Command execution via subprocess
- [x] JSON output parsing
- [x] Availability check
- [ ] Custom command support (`.opencode/commands/*.md`)
- [ ] Session ID tracking and persistence

### Repository Loader
- [x] Local path resolution
- [x] Git clone helper with GitPython
- [x] Git URL detection (HTTPS, SSH, Git protocol)
- [x] Git URL parsing (extract owner/repo from URL)
- [x] Automatic cloning to `./tmp/owner/repo`
- [x] Clone reuse (don't re-clone if already exists)
- [x] Force re-clone support
- [x] Cleanup utilities for removing clones
- [x] Integration with CLI analyze command
- [ ] Authentication stub (currently uses system Git credentials)

### Analyzer
- [ ] Prompt preparation for OpenCode
- [ ] Tree-sitter/AST integration for local enrichment
- [ ] Python language support
- [ ] JavaScript/TypeScript language support

### Documentation Generator
- [ ] Markdown file writer
- [ ] Table of contents builder
- [ ] Index creation
- [ ] OpenCode artifact ingestion

### Diagram Generator
- [ ] Mermaid component diagram emission
- [ ] OpenCode diagram import
- [ ] `.mmd` file writers

### Output Manager
- [x] Directory structure creation
- [x] Metadata/log persistence (JSON format with timestamp)
- [x] Analysis summary generation (Markdown)
- [x] Raw output saving
- [x] Structured JSON output parsing
- [x] OpenCode session ID recording
- [ ] Config tracking
- [ ] Diagram/artifact file organization

### Claude Code Fallback
- [ ] Claude Code CLI integration
- [ ] `--allowedTools` gating
- [ ] Fallback switching logic

### Deliverables
- [ ] `repo-explainer analyze` producing markdown + diagrams
- [ ] `repo-explainer update` for incremental updates
- [ ] `.opencode/commands/analyze-architecture.md`
- [ ] Quick/standard/deep command variants
- [ ] Claude Code equivalent documentation
- [ ] Verified prompts for Gemini 3 Flash Preview
