# Claude Development Guidelines

This file documents the guidelines I follow while working on this project.

## Documentation Commitment

### 1. API Documentation (`docs.md`)
- **When**: Updated after every meaningful API change
- **What**: Public interfaces, CLI commands, configuration, service methods
- **Format**: Markdown with examples and clear parameter descriptions

### 2. Changelog Tracking
- API additions/changes are immediately reflected in `docs.md`
- Major breaking changes are flagged clearly
- New features include usage examples

### 3. Code Organization
- All new modules are documented with docstrings
- Public functions include type hints and docstrings
- Complex logic includes inline comments explaining the "why"

## Development Process

### Before Writing Code
1. Check existing patterns in the codebase
2. Consider the stage deliverables
3. Plan multi-step tasks with TodoWrite

### While Writing Code
1. Prefer editing existing files over creating new ones
2. Keep solutions focused and simple (avoid over-engineering)
3. Only add what's needed for the current task
4. Write defensive code at system boundaries (user input, external APIs)

### After Completing Features
1. Update `docs.md` with new APIs/commands
2. Update `stages/stage_1.md` checklist
3. Test the feature with provided examples
4. Commit with clear message describing changes

## Testing Guidelines

### CLI Testing
- Use `--help` to verify command structure
- Use `--verbose` to debug issues
- Test with real repository paths
- Document common issues and solutions in `docs.md`

### Manual Verification
- Test each new command after implementation
- Verify error handling works gracefully
- Check that configuration is read correctly

## When to Escalate
- If OpenCode API changes, update service wrapper
- If configuration structure changes, update Settings class
- If CLI commands change, update help text and docs
- If dependencies are added, update `pyproject.toml` and mention in docs

## Change Log

### 2026-01-17 - Robust Mermaid Error Handling

**Feature: Graceful Diagram Rendering Failures**
- Made DocComposer resilient to Mermaid syntax errors
- System continues and generates complete documentation even when diagrams fail
- Provides helpful guidance to users for fixing syntax errors

**Improvements:**
- Always tracks .mermaid source files even when rendering fails
- Shows simplified error messages (first line only, no verbose stack traces)
- Adds helpful notes in generated docs with manual rendering instructions
- Displays summary: "X successful, Y failed diagrams"
- Tracks failures across all error types (syntax errors, timeouts, exceptions)

**User Experience:**
```
Rendering 2 diagram(s)...
  ‚ö† Syntax error in dataflow.mermaid:
    Source available at dataflow.mermaid
‚ö† 2 diagram(s) failed (source files available)
```

**Generated Documentation:**
- index.md shows warnings when diagrams fail to render
- Subpages include detailed help with manual rendering commands
- Links to Mermaid documentation for syntax reference
- Clear instructions: "Fix the syntax and render manually with `mmdc -i file.mermaid -o file.svg`"

---

### 2026-01-17 - Coherent Documentation Generation

**Feature: Structured, Navigable Documentation**
- Implemented coherent documentation generation from raw OpenCode artifacts
- Creates `index.md` as a central entry point with navigation
- Generates organized subpages (components.md, dataflow.md, tech-stack.md)
- Renders Mermaid diagrams to SVG for embedded visualization
- No more scattered files - documentation is now a navigable site

**Implementation:**
- Created `DocComposer` module for document composition
- Integrated Mermaid CLI (`mmdc`) for diagram rendering
- Added automatic composition after OpenCode analysis completes
- Graceful degradation if Mermaid CLI is not available

**Generated Structure:**
```
docs/
‚îú‚îÄ‚îÄ index.md                   # Main entry point
‚îú‚îÄ‚îÄ components.md              # Component architecture
‚îú‚îÄ‚îÄ dataflow.md                # Data flow visualization
‚îú‚îÄ‚îÄ tech-stack.md              # Technology stack
‚îú‚îÄ‚îÄ diagrams/
‚îÇ   ‚îú‚îÄ‚îÄ components.svg         # Rendered diagrams
‚îÇ   ‚îî‚îÄ‚îÄ dataflow.svg
‚îú‚îÄ‚îÄ architecture.md            # Raw OpenCode output
‚îú‚îÄ‚îÄ *.mermaid                  # Mermaid sources
‚îî‚îÄ‚îÄ .repo-explainer/
    ‚îî‚îÄ‚îÄ coherence.json         # Generation manifest
```

**CLI Changes:**
- Output now highlights coherent docs first with üìö section
- Technical artifacts shown separately with üîß section
- Tip message points to `index.md` instead of `ANALYSIS_SUMMARY.md`
- Clear visual separation between human-readable docs and technical files

**Validation:**
- Created `validate_coherence.py` script
- Checks index.md exists and has valid links
- Verifies subpages, diagrams, and manifest
- Provides detailed validation report

**Usage:**
```bash
repo-explain analyze ./my-project

# Output:
# üìö Coherent Documentation:
#   - index.md (Start here!)
#   - components.md
#   - dataflow.md
#   - tech-stack.md
#
# üí° Tip: Open `docs/index.md` to start exploring

# Validate structure:
python validate_coherence.py docs
```

**Technical Details:**
- DocComposer.compose() orchestrates all generation
- Mermaid CLI called via subprocess for SVG rendering
- Subpages extract sections from architecture.md
- Manifest tracks all generated files with timestamps
- Follows coherence plan from coherence.md specification

---

### 2025-01-17 - Real-Time Verbose Mode

**Feature: Live Activity Logging**
- Added real-time streaming of OpenCode events in verbose mode
- Shows what OpenCode is doing as it happens
- No more blind waiting - see files being read, commands executed, etc.

**Implementation:**
- Modified OpenCode service to use `subprocess.Popen` for streaming
- Parse JSON events line-by-line in real-time
- Event callback system for processing tool calls
- Display tool activity with emoji indicators

**Verbose Output Shows:**
- üìÑ Files being read: `Reading: path/to/file.py`
- ‚öôÔ∏è  Commands running: `Running: List files in directory`
- ‚úèÔ∏è  Files being written: `Writing: architecture.md`
- üîç Search patterns: `Searching: *.py`

**CLI Changes:**
- `--verbose` flag now streams OpenCode activity
- Event handler processes tool_use events
- Extracts file paths, descriptions, and commands
- Displays activity in real-time during analysis

**Usage:**
```bash
repo-explain analyze ./my-project --verbose

# Output:
# Verbose mode: Showing OpenCode activity...
#   ‚öôÔ∏è  Running: List files in the root directory
#   üìÑ Reading: /path/to/main.py
#   üìÑ Reading: /path/to/README.md
#   ‚úèÔ∏è  Writing: architecture.md
```

**Technical Details:**
- Uses subprocess.Popen with line buffering
- Parses newline-delimited JSON events
- Callbacks executed for each event
- No spinner in verbose mode (replaced with live activity)

---

### 2025-01-17 - Output Manager Added

**Feature: Output File Generation**
- Created `output_manager.py` module to save analysis results
- Analysis results now saved to configurable output directory (default: `./docs/`)
- Generated files include:
  - `ANALYSIS_SUMMARY.md` - Markdown summary with session info
  - `analysis_{depth}.json` - Structured JSON output (parsed events)
  - `logs/analysis_{timestamp}.txt` - Raw OpenCode output
  - `logs/metadata_{timestamp}.json` - Analysis metadata

**CLI Updates**
- Shows output location after analysis completes
- Lists all generated files with relative paths
- Displays OpenCode session ID and artifacts
- Verbose mode shows first 500 chars of raw output

**API Changes**
- New `OutputManager` class with methods:
  - `write_analysis_result(result, repo_path, depth)` - Main entry point
  - `get_output_location()` - Returns output directory path
  - `ensure_directories()` - Creates output structure

**Documentation Updated**
- README.md: Added "Where are results saved?" section
- docs.md: Updated to show actual output files generated
- Both docs explain the output directory structure

---

### 2025-01-17 - Git URL Support Added

**Major Feature: Git URL Support**
- Created `repository_loader.py` module with full Git clone support
- CLI now accepts Git URLs in addition to local paths
- Repositories automatically cloned to `./tmp/owner/repo` structure
- Added `--force-clone` flag to re-clone existing repositories
- Supports HTTPS, SSH, and Git protocol URLs
- Existing clones are automatically reused (no unnecessary re-cloning)

**API Changes**
- `repo-explain analyze` now accepts `[REPO_PATH_OR_URL]` instead of just `[REPO_PATH]`
- Added `--force-clone` option
- New `RepositoryLoader` class with methods:
  - `load(path_or_url, force_clone)` - Main entry point
  - `is_git_url(path_or_url)` - Detects Git URLs
  - `parse_git_url(git_url)` - Extracts owner/repo
  - `clone_repository(git_url, force)` - Clones repo
  - `cleanup(owner, repo)` - Removes clones

**Documentation Updated**
- Added extensive Git URL examples to `docs.md`
- Documented RepositoryLoader service API
- Added Git clone troubleshooting section
- Added validation tests for Git URLs
- Updated all examples to show both local and remote usage

**Testing**
- Verified with real GitHub repository (octocat/Hello-World)
- Confirmed clone to correct path (./tmp/octocat/Hello-World)
- Verified clone reuse on subsequent runs
- Tested --force-clone flag successfully

---

### 2025-01-17 - Initial Release

**Fixed OpenCode CLI Integration**
- Updated `opencode_service.py` to use correct CLI syntax: `opencode run <prompt> --format json`
- Removed incorrect `-p` and `-f` flags (OpenCode doesn't use those)
- Removed `--command` flag for custom commands (will implement `.opencode/commands/` structure next)
- Service now successfully invokes OpenCode and receives structured JSON output
- CLI tests pass: `repo-explain analyze . --depth quick --verbose` successfully runs

**Documentation Created**
- `docs.md` - Complete API documentation with examples
- `.claude.md` - This guidelines file for maintaining consistency
- Added API changes tracking section to docs.md

---

Last Updated: 2026-01-17 - Coherent documentation generation complete
