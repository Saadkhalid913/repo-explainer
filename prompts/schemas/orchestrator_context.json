{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Orchestrator Context Contract",
  "description": "JSON schema for context data that Stage 2+ orchestrators expect from analysis prompts",
  "type": "object",
  "required": ["repository", "analysis", "components"],
  "properties": {
    "repository": {
      "type": "object",
      "description": "Repository metadata and summary",
      "required": ["name", "path", "primary_language"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Repository name"
        },
        "path": {
          "type": "string",
          "description": "Local filesystem path or Git URL"
        },
        "primary_language": {
          "type": "string",
          "description": "Detected primary programming language"
        },
        "languages": {
          "type": "array",
          "items": {"type": "string"},
          "description": "All languages detected in repository"
        },
        "size_category": {
          "type": "string",
          "enum": ["small", "medium", "large", "very_large"],
          "description": "Repository size classification"
        },
        "entry_points": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Main entry point files with paths"
        }
      }
    },
    "analysis": {
      "type": "object",
      "description": "Analysis session metadata",
      "required": ["session_id", "timestamp", "depth"],
      "properties": {
        "session_id": {
          "type": "string",
          "description": "OpenCode/Claude session identifier"
        },
        "timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "Analysis start timestamp"
        },
        "depth": {
          "type": "string",
          "enum": ["quick", "standard", "deep"],
          "description": "Analysis depth level"
        },
        "token_usage": {
          "type": "object",
          "properties": {
            "input_tokens": {"type": "integer"},
            "output_tokens": {"type": "integer"},
            "total_cost_usd": {"type": "number"}
          }
        },
        "duration_seconds": {
          "type": "number",
          "description": "Total analysis duration"
        }
      }
    },
    "components": {
      "type": "array",
      "description": "List of identified components/modules",
      "items": {
        "type": "object",
        "required": ["component_id", "name", "type", "file_path"],
        "properties": {
          "component_id": {
            "type": "string",
            "description": "Unique component identifier"
          },
          "name": {
            "type": "string",
            "description": "Component name"
          },
          "type": {
            "type": "string",
            "enum": ["service", "module", "package", "class", "function", "library"],
            "description": "Component type classification"
          },
          "file_path": {
            "type": "string",
            "description": "Primary source file path (relative to repo root)"
          },
          "line_range": {
            "type": "object",
            "properties": {
              "start": {"type": "integer"},
              "end": {"type": "integer"}
            },
            "description": "Line range in source file (optional)"
          },
          "description": {
            "type": "string",
            "description": "Component purpose and responsibilities"
          },
          "key_functions": {
            "type": "array",
            "description": "Important functions/methods in this component",
            "items": {
              "type": "object",
              "properties": {
                "name": {"type": "string"},
                "file_path": {"type": "string"},
                "line_range": {
                  "type": "object",
                  "properties": {
                    "start": {"type": "integer"},
                    "end": {"type": "integer"}
                  }
                },
                "signature": {"type": "string"},
                "purpose": {"type": "string"}
              }
            }
          },
          "dependencies": {
            "type": "object",
            "properties": {
              "internal": {
                "type": "array",
                "items": {"type": "string"},
                "description": "Component IDs this component depends on"
              },
              "external": {
                "type": "array",
                "items": {"type": "string"},
                "description": "External package dependencies"
              }
            }
          },
          "interfaces": {
            "type": "array",
            "description": "Public APIs or interfaces exposed",
            "items": {
              "type": "object",
              "properties": {
                "name": {"type": "string"},
                "type": {"type": "string", "enum": ["REST", "GraphQL", "gRPC", "function", "class"]},
                "endpoints": {"type": "array", "items": {"type": "string"}}
              }
            }
          }
        }
      }
    },
    "dependencies": {
      "type": "object",
      "description": "Dependency analysis results",
      "properties": {
        "external_packages": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "name": {"type": "string"},
              "version": {"type": "string"},
              "manager": {"type": "string", "enum": ["npm", "pip", "maven", "cargo", "go", "composer"]},
              "used_by_components": {"type": "array", "items": {"type": "string"}}
            }
          }
        },
        "internal_graph": {
          "type": "array",
          "description": "Component dependency relationships",
          "items": {
            "type": "object",
            "properties": {
              "from": {"type": "string", "description": "Source component ID"},
              "to": {"type": "string", "description": "Target component ID"},
              "relationship": {"type": "string", "enum": ["imports", "calls", "extends", "implements", "uses"]}
            }
          }
        }
      }
    },
    "patterns": {
      "type": "object",
      "description": "Detected architectural and design patterns",
      "properties": {
        "architectural": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "name": {"type": "string", "enum": ["MVC", "Microservices", "Layered", "Event-driven", "CQRS", "Hexagonal"]},
              "confidence": {"type": "number", "minimum": 0, "maximum": 1},
              "evidence": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "file_path": {"type": "string"},
                    "description": {"type": "string"}
                  }
                }
              }
            }
          }
        },
        "design": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "name": {"type": "string"},
              "instances": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "file_path": {"type": "string"},
                    "line_range": {
                      "type": "object",
                      "properties": {
                        "start": {"type": "integer"},
                        "end": {"type": "integer"}
                      }
                    },
                    "description": {"type": "string"}
                  }
                }
              }
            }
          }
        }
      }
    },
    "diagrams": {
      "type": "object",
      "description": "Generated diagram metadata",
      "properties": {
        "architecture": {
          "type": "object",
          "properties": {
            "mermaid_file": {"type": "string"},
            "svg_file": {"type": "string"},
            "components_shown": {"type": "array", "items": {"type": "string"}}
          }
        },
        "dataflow": {
          "type": "object",
          "properties": {
            "mermaid_file": {"type": "string"},
            "svg_file": {"type": "string"},
            "flows_documented": {"type": "array", "items": {"type": "string"}}
          }
        },
        "sequence": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "name": {"type": "string"},
              "mermaid_file": {"type": "string"},
              "participants": {"type": "array", "items": {"type": "string"}}
            }
          }
        },
        "er_diagrams": {
          "type": "array",
          "items": {
            "type": "object"},
            "properties": {
              "name": {"type": "string"},
              "mermaid_file": {"type": "string"},
              "entities": {"type": "array", "items": {"type": "string"}}
            }
          }
        }
      }
    },
    "artifacts": {
      "type": "object",
      "description": "Generated artifact file paths",
      "properties": {
        "architecture_md": {"type": "string"},
        "components_mermaid": {"type": "string"},
        "dataflow_mermaid": {"type": "string"},
        "tech_stack_txt": {"type": "string"},
        "patterns_md": {"type": "string"}
      }
    }
  }
}
